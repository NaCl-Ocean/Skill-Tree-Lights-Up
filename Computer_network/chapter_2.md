# 数据链路层

![image-20200804155910836](images/image-20200804155910836.png)

- 路由器在链路层检查目的Mac地址是否是自己，若是则进入网络层，根据IP地址选择下一跳地址，将数据帧的Mac地址写为目的路由器（主机,...）的Mac地址

**数据链路层传输的是帧**

**数据链路层使用的信道**

- **点对点信道：PPP协议，SLIP协议**
- **广播信道：多址协议**

链路：点到点的物理线路段

数据链路：链路+通信协议

**数据链路层解决的三个问题**

- **封装成帧**：帧头，帧尾
- **透明传输**
  - 通过转义字符，使得传输数据内容不同于枕头和帧尾
- **差错控制**
  - 奇偶校验
  - CRC 循环冗余校验
    - 在数据后面添加的冗余码称为帧检验序列**FCS （Frame Check Sequence)**
  - 有差错，丢掉，但是不管是否要重传



**数据链路层成帧的方法**

- 字符计数法：帧的第一个字节说明当前帧的长度
- 字符填充的首尾界定法：在帧的头之前和尾之后加一个特殊的字符，只要读到这个字符帧就开始了，再次读到就认为这个帧结束了
- 比特填充的首尾界定法：和字符填充法类似，只是在转义时不同，参见下文



## 点对点协议

点对点线路

PPP协议

- 优点
  - 身份验证
  - 简单
  - 封装成帧
  - 透明传输
  - 支持多种网络层协议
  - 支持多种链路
- 帧的格式
  - ![image-20200804165522361](images/image-20200804165522361.png)
  - 最开始的7E表示帧的起始，最末的7E表示帧的结束
  - 接下来的FF表示目标地址，**但是由于点对点，因此目标地址无意义，写为FF**
  - 协议部分表示传输的数据是什么数据
    - 0x0021 时，表述传输的是IP数据报
    - 0xC021, 表示传输的是 PPP 链路控制数据。
    - ...
  - FCS 冗余校验码
- 如何实现透明传输
  - 异步传输：字符填充法
    - 若信息字段出现7E，将7E拆分为7D-5E
    - 若信息字段出现7D，则7D写为7D-5D
  - 同步传输：零比特填充
    - 在发送端，只要检测到连续5个1，则在后面插入一个0
    - 接受端，检测到连续5个1，删除后面的的一个0
  - 什么是同步传输：传输以bit为单位，异步传输以字节为单位进行传输



**SLIP 协议**

- 利用 END特殊字符（C0）来表示帧的起始和结束，利用ESC特殊字符（DB）进行转义
- 如何实现透明传输
  - 信息字段中出现END，转换为ESC-END
  - 信息字段中出现ESC，转换为ESC-ESC
- 没有差错检测

## 局域网

**广播信道**

路由器的以太网口一般用来组建局域网，serial口用来组建广域网

拓扑

- 星型网
  - 集线器
  - 本机发送的消息其他连入此集线器的设备都可以收到，除了本机
- 总线网
- 环形网
- 树形网

**使用MAC帧**



### 共享通信媒体

静态划分信道/固定分配多址接入协议

- 频分多址
- 时分多址
- 空分多址
- 码分多址

动态媒体接入控制/随机分配多址接入协议

- ALOHA
- CSMA
  - 基本的CSMA协议
    - 非持续CSMA：当要发送帧的设备侦听到线路忙或发生碰撞时，会随机等待一段时间再进行侦听；若发现不忙则立即发送
    - 1-持续CSMA：当要发送帧的设备侦听到线路忙或发生碰撞时，会持续侦听；若发现不忙则立即发送。
    - p-持续CSMA：当要发送帧的设备侦听到线路忙或发生碰撞时，会持续侦听；若发现不忙，则根据一个事先指定的概率p来决定是发送帧还是继续侦听（以p的概率发送，1-p的概率继续侦听）
  - CSMA/CD--》以太网
    - 相比于基本的CSMA协议，增加了冲突检测
  - CSMA/CA

基于预约方式的多址接入协议



## 以太网

**局域网**

**CSMA/CD协议**（Carrier Sense Multiple Access/collision detection）

- 多点接入：许多计算机以多点接入的方式连在一根总线上
- 冲突检测：每一个站在发送数据之前检测总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据（1-坚持型），发送数据后，对冲突进行检测，若有冲突，则取消发送，在固定时间内等待随机时间，再次发送，若依旧碰撞，则采用二进制指数类型退避算法进行发送
- 半双工通信





### 争用期

- 计算机发送数据后，最多经过$2\tau$ 时间检测到是否发生了碰撞，端到端传播时延的两倍
- 以太网中规定$2\tau =51.2\mu s$ ,对于10Mb/s的以太网，在争用期可以发送512bit，即64byte
- 也就是说，发送的最开始64byte没有发生冲突，则后续发送的数据不会有冲突，而发生冲突也只可能发生在最开始发送的64byte中
- 由于一检测到冲突立马停止发送，这是发出的数据小于等于64byte，因此以太网规定最短有效帧长64byte，收到的帧长小于64byte的都是无效帧
- 注意：**在数据链路层，是一帧一帧发的，也就是相邻两帧可以不连着发，但是一帧内的所有Bit必须连着一起发**



### 二进制指数类型退避算法

- 发生碰撞后，先停止发送数据，之后推迟一个随机时间再发送数据（当然发送数据前仍然要利用CSMA/CD协议）
- 基本退避时间，$2\tau$，端到端传播时延的两倍
- 定义重传次数 *k* ，$k\le 10$，即 *k* = Min[重传次数, 10]
- 从整数集合[0,1,…, ($2^k$ -1)]中随机地取出一个数，记为 *r*。重传所需的时延就是 *r* 倍的基本退避时间。
- 当重传达 16 次仍不能成功时即丢弃该帧，并向高层报告



**以太网的两个标准**

- DIX Ethernet V2  --》严格意义上的以太网
- IEEE 802.3



**以太网数据链路层的2个子层**

- 逻辑链路控制 LLC（Logical Link Control)   --》现在基本不用
- 媒体接入控制MAC（Medium Access Control）



**以太网提供的服务**

- 不可靠的交付
- 帧出错，就丢弃此帧，不做其他的事情

主要采用星型拓扑



### 信道利用率

- 帧长为L（bit），数据发送率为C（b/s），帧的发送时间$T_0 = \frac{L}{C}$
- 争用期长度$2\tau$
- 定义一个参数$\alpha = \frac{\tau}{T_0}$
- $\alpha$ 越大，信道利用率越大，争用期越短（端到端距离越短），帧长越长，信道利用率越大

- 极限信道利用$S_{max}=\frac{T_0}{T_0+\tau}=\frac{1}{a+\alpha}$（理想情况，没有争用期，没有冲突）
- ![1](images/1.jpg)





### MAC地址

- 每个网卡有一个全球唯一的MAC地址，固定到芯片上
- **48位二进制**，前24位标识厂家，后24位厂家指定



### MAC帧

![image-20200810154049269](images/image-20200810154049269.png)



**无效的MAC帧**

- 数据字段的长度与长度字段的值不一致；

- 帧的长度不是整数个字节；

- 用收到的帧检验序列 FCS 查出有差错；

- 数据字段的长度不在 46 ~ 1500 字节之间。**有效的 MAC 帧长度为 64 ~ 1518 字节之间**。

对于检查出的无效 MAC 帧就简单地丢弃。以太网不负责重传丢弃的帧。



扩展以太网

- ![image-20200810161309029](images/image-20200810161309029.png)
  - 效率降低，此时是一个大的冲突域，该域中的所有机器只允许2台机器同时通信
- 网桥
  - ![image-20200810161636803](images/image-20200810161636803.png)
  - 需要有一个学习的过程
  - 网桥收到一帧后先进行自学习。查找转发表中与收到帧的源地址有无相匹配的项目。如没有，就在**转发表**中增加一个项目（**源地址、进入的接口**和时间）。如有，则把原有的项目进行更新。
  - 转发帧。查找转发表中与收到帧的目的地址有无相匹配的项目。
    - 如没有，则通过所有其他接口（但进入网桥的接口除外）按进行转发。
    - 如有，则按转发表中给出的接口进行转发。
    - 若转发表中给出的接口就是该帧进入网桥的接口，则应丢弃这个帧（因为这时**不需要经过网桥进行转发**）。
  - 相比于交换机，效率提高，不需要将消息广播给所有的计算机，只需要广播给目的计算机所在的接口

- 交换机实质上是网桥，有很多接口，每个接口只连一台计算机



## VLAN

VLAN 是由一些局域网网段构成的**与物理位置无关的逻辑组**

- 每一个 VLAN 的帧都有一个明确的标识符，指明发送这个帧的工作站是属于哪一个 VLAN。
- 不同vlan下的计算机无法通信

VLAN 之间路由需要通过路由器或者三层交换机

跑多个VLAN数据的端口配置为中继端口（Trunk)

跑单个VLAN数据的端口配置为Access端口

**VLAN标记（tag）**指明发送发送帧的计算机属于哪个VLAN，在MAC帧中插入

![image-20200810165239041](images/image-20200810165239041.png)



